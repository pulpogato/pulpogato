= Pulpogato
:package: io.github.pulpogato
:package-path: io/github/pulpogato
:package-path-encoded: io%2Fgithub%2Fpulpogato
:snapshot-prefix: image:https://img.shields.io/maven-metadata/v?metadataUrl=https%3A%2F%2Fcentral.sonatype.com%2Frepository%2Fmaven-snapshots%2F{package-path-encoded}%2F
:snapshot-middle: %2Fmaven-metadata.xml&style=for-the-badge&label=S[alt=Maven Snapshot,height=30,link="https://central.sonatype.com/repository/maven-snapshots/{package-path}/
:snapshot-suffix: /maven-metadata.xml"]
:central-prefix: image:https://img.shields.io/maven-central/v/{package}/
:central-middle: ?style=for-the-badge&label=R&color=green[alt=Maven Central Version,height=30,link="https://central.sonatype.com/artifact/{package}/
:central-suffix: /overview"]
:deprecated-middle: ?style=for-the-badge&label=R&color=lightgrey[alt=Maven Central Version,height=30,link="https://central.sonatype.com/artifact/{package}/
:nofooter:
:source-highlighter: rouge
:toc: left
:icons: font

Pulpogato is a java client for GitHub.

== Installation

include::../../README.adoc[tags=installation]

== Usage

=== REST Client Example

This shows how to create a REST client and get the authenticated user.
Ideally, you would inject the WebClient and export a Bean for RestClients.
If you're supporting multiple GitHub Apps or sites, you would export a factory bean instead.

[source,java]
----
public class RestExample {
    public static void main(String[] args) {
        // create a WebClient
        WebClient webClient = WebClient.builder()
                .baseUrl("https://api.github.com")
                .defaultHeader(HttpHeaders.AUTHORIZATION, "Bearer ...your token here...")
                .build();

include::../../pulpogato-rest-fpt/src/test/java/io/github/pulpogato/rest/api/UsersApiIntegrationTest.java[tags=getAuthenticatedPublic]
include::../../pulpogato-rest-fpt/src/test/java/io/github/pulpogato/rest/api/UsersApiIntegrationTest.java[tags=getBody]
include::../../pulpogato-rest-fpt/src/test/java/io/github/pulpogato/rest/api/UsersApiIntegrationTest.java[tags=getUser]
include::../../pulpogato-rest-fpt/src/test/java/io/github/pulpogato/rest/api/UsersApiIntegrationTest.java[tags=getLogin]

    }
}
----

=== Webhook Example

This shows how to create a Webhook handler that listens for ping events.
There are many other event types you can listen for.

[source,java,indent=0]
----
include::../../pulpogato-rest-fpt/src/test/java/io/github/pulpogato/rest/webhooks/PingWebhooksIntegrationTest.java[tags=ping-webhook-controller]
----

=== GraphQL Client Example

This shows how to create a GraphQL client and get the authenticated user.
Ideally, you would inject the WebClient and export a Bean for GraphQLClients.
If you're supporting multiple GitHub Apps or sites, you would export a factory bean instead.

This example uses a String for the query.

[source,java]
----
public class GraphQlExample {

include::../../pulpogato-graphql-fpt/src/test/java/io/github/pulpogato/graphql/FindOpenPullRequestsTest.java[tags=query]

    public static void main(String[] args) {
        // create a WebClient
        WebClient graphqlWebClient = WebClient.builder()
                .baseUrl("https://api.github.com/graphql")
                .defaultHeader(HttpHeaders.AUTHORIZATION, "Bearer ...your token here...")
                .build();

include::../../pulpogato-graphql-fpt/src/test/java/io/github/pulpogato/graphql/FindOpenPullRequestsTest.java[tags=execute]

include::../../pulpogato-graphql-fpt/src/test/java/io/github/pulpogato/graphql/FindOpenPullRequestsTest.java[tags=extract]

    }
}
----
<1> Set variables for the query

=== GitHub Files Example

`pulpogato-github-files` provides typed models for common GitHub repository files:

* GitHub workflow files (`.github/workflows/*.yml`) as `GithubWorkflow`
* GitHub Action metadata (`action.yml`) as `GithubAction`
* Release Drafter config (`.github/release.yml`) as `GithubReleaseConfig`

The module supports both Jackson 2 (`com.fasterxml.jackson`) and Jackson 3 (`tools.jackson`).

Dependency:

[source,kotlin]
----
implementation("io.github.pulpogato:pulpogato-github-files:<version>")
----

Jackson 2 YAML parsing example:

[source,java,indent=0]
----
include::../../pulpogato-github-files/src/test/java/io/github/pulpogato/githubfiles/DocumentationIntegrationTest.java[tags=github-files-jackson2]
----

Jackson 3 YAML parsing example:

[source,java,indent=0]
----
include::../../pulpogato-github-files/src/test/java/io/github/pulpogato/githubfiles/DocumentationIntegrationTest.java[tags=github-files-jackson3]
----

Release Drafter parsing example:

[source,java,indent=0]
----
include::../../pulpogato-github-files/src/test/java/io/github/pulpogato/githubfiles/DocumentationIntegrationTest.java[tags=github-files-release]
----

Many fields in these schemas are unions (for example, `on` in workflows can be a string, list, or object).
These are represented as typed wrapper objects with one populated field per variant.

[source,java,indent=0]
----
include::../../pulpogato-github-files/src/test/java/io/github/pulpogato/githubfiles/DocumentationIntegrationTest.java[tags=github-files-on-union]
----

== GitHub App JWT Authentication

Pulpogato provides `JwtFilter` to authenticate as a GitHub App using JSON Web Tokens (JWT).
This is useful when you need to authenticate as the app itself rather than as an installation.

=== JWT Filter Setup

[source,java,indent=0]
----
include::../../pulpogato-common/src/test/java/io/github/pulpogato/common/DocumentationIntegrationTest.java[tags=setup-jwt]
----
<1> The RSA private key in PEM format (PKCS#1 or PKCS#8), loaded from your GitHub App settings
<2> Your GitHub App ID (or client ID) as a string
<3> Add the filter to your WebClient

The filter:

* Generates RS256-signed JWTs per GitHub's requirements
* Sets `iat` (issued at) 60 seconds in the past to account for clock drift
* Sets `exp` (expiration) to 9 minutes in the future
* Caches tokens and refreshes them 30 seconds before expiry
* Supports both PKCS#1 (`BEGIN RSA PRIVATE KEY`) and PKCS#8 (`BEGIN PRIVATE KEY`) formats

== HTTP Caching

Pulpogato provides `CachingExchangeFilterFunction` to cache HTTP responses based on standard HTTP caching headers (ETag, Last-Modified, Cache-Control).
This can significantly reduce API calls and improve performance.

=== Basic Caching Setup

[source,java,indent=0]
----
include::../../pulpogato-common/src/test/java/io/github/pulpogato/common/DocumentationIntegrationTest.java[tags=setup-cache]
----
<1> This is a Spring Cache (ConcurrentMapCache, Caffeine, Redis, etc.)
<2> You can add multiple filters here. This filter configures caching.

The filter handles:

* **ETag / If-None-Match**: Stores the ETag and sends conditional requests
* **Last-Modified / If-Modified-Since**: Stores the last modified date and sends conditional requests
* **Cache-Control max-age**: Returns cached responses directly while fresh

The response includes an `X-Pulpogato-Cache` header indicating the cache status:

* `HIT` - Response served from cache without server request
* `MISS` - Response fetched from server and cached
* `REVALIDATED` - Server returned 304, cached response body returned
* `SKIP` - Response too large to cache (still returned to caller)

=== Advanced Caching Options

[source,java,indent=0]
----
include::../../pulpogato-common/src/test/java/io/github/pulpogato/common/DocumentationIntegrationTest.java[tags=advanced-cache]
----
<1> Custom function to generate cache keys from requests
<2> Maximum response size to cache (default: 2MB)
<3> Always send conditional requests even if cache is fresh. This is helpful when GitHub's cache directive is too long for your usecase.

== Rate Limit Metrics

Pulpogato provides `MetricsExchangeFunction` to capture GitHub API rate limit information as Micrometer metrics.
This helps monitor your API usage and avoid hitting rate limits.

=== Basic Metrics Setup

[source,java,indent=0]
----
include::../../pulpogato-common/src/test/java/io/github/pulpogato/common/DocumentationIntegrationTest.java[tags=setup-metrics]
----
<1> This is a Micrometer MeterRegistry (SimpleMeterRegistry, PrometheusMeterRegistry, etc.) It could be injected from Spring.

The filter extracts these headers from GitHub responses and creates gauges:

* `github.api.rateLimit.limit` - Maximum requests allowed
* `github.api.rateLimit.remaining` - Requests remaining in current window
* `github.api.rateLimit.used` - Requests used in current window
* `github.api.rateLimit.secondsToReset` - Seconds until rate limit resets

All metrics are tagged with the `resource` (e.g., "core", "search", "graphql").

=== Advanced Metrics Options

[source,java,indent=0]
----
include::../../pulpogato-common/src/test/java/io/github/pulpogato/common/DocumentationIntegrationTest.java[tags=advanced-metrics]
----
<1> Custom metric name prefix
<2> Additional tags to add to all metrics
